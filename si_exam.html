<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bihar SI Exam Engine</title>
    <style>
        /* CSS Reset & Basics */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7f6; display: flex; flex-direction: column; overflow: hidden; user-select: none; height: 100vh; }
        
        /* Top Bar */
        .top-bar { 
            height: 60px; 
            background: #1a237e; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .top-bar h3 { margin: 0; font-size: 18px; }
        
        .timer { 
            font-family: monospace; 
            font-size: 20px; 
            background: #000; 
            color: #00e676; 
            padding: 5px 12px; 
            border-radius: 4px;
            min-width: 80px;
            text-align: center;
        }
        
        /* Layout */
        .wrapper { display: flex; flex: 1; overflow: hidden; gap: 0; }
        
        /* Left: Question Area */
        .q-area { 
            flex: 1; 
            padding: 25px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column;
            background: white;
        }
        
        .q-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px; 
            border-bottom: 2px solid #e0e0e0; 
            padding-bottom: 10px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .q-header h3 { margin: 0; font-size: 16px; }
        
        .q-text { 
            font-size: 16px; 
            line-height: 1.6; 
            margin-bottom: 20px; 
            color: #333; 
        }
        
        .q-hindi { 
            font-size: 18px; 
            color: #1a237e; 
            margin-bottom: 10px; 
            font-family: 'Nirmala UI', sans-serif;
            line-height: 1.6;
        }
        
        /* Options */
        .options { display: flex; flex-direction: column; gap: 10px; }
        
        .opt-label { 
            display: flex; 
            align-items: center; 
            padding: 12px 15px; 
            background: white; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: 0.2s;
            font-size: 14px;
        }
        
        .opt-label:hover { background: #e8eaf6; border-color: #3f51b5; }
        .opt-label.selected { background: #e8f5e9; border-color: #2e7d32; font-weight: bold; }
        .opt-input { margin-right: 12px; width: 16px; height: 16px; min-width: 16px; }

        /* Buttons */
        .footer { 
            margin-top: auto; 
            padding-top: 20px; 
            display: flex; 
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn { 
            padding: 10px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            color: white; 
            font-size: 13px;
            flex: 1;
            min-width: 100px;
            transition: 0.3s;
        }
        
        .btn:active { transform: scale(0.98); }
        
        .btn-save { background: #2e7d32; }
        .btn-save:hover { background: #1b5e20; }
        
        .btn-mark { background: #f57c00; }
        .btn-mark:hover { background: #e65100; }
        
        .btn-clear { background: #78909c; }
        .btn-clear:hover { background: #546e7a; }
        
        .btn-submit { background: #c62828; }
        .btn-submit:hover { background: #ad1457; }

        /* Right: Palette */
        .sidebar { 
            width: 280px; 
            background: white; 
            border-left: 1px solid #ddd; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        }
        
        .candidate-info { 
            padding: 15px; 
            background: #e3f2fd; 
            border-bottom: 1px solid #bbdefb;
            font-size: 13px;
            flex-shrink: 0;
        }
        
        .candidate-info strong { display: block; }
        .candidate-info small { color: #666; }
        
        .palette-grid { 
            padding: 12px; 
            overflow-y: auto; 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 6px; 
            align-content: start;
            flex: 1;
        }
        
        .p-btn { 
            aspect-ratio: 1; 
            border: 1px solid #ccc; 
            background: white; 
            cursor: pointer; 
            border-radius: 4px; 
            font-weight: bold; 
            font-size: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: 0.2s;
        }
        
        .p-btn:active { transform: scale(0.95); }
        
        .p-btn.ans { background: #2e7d32; color: white; border-color: #2e7d32; }
        .p-btn.not-ans { background: #c62828; color: white; border-color: #c62828; }
        .p-btn.marked { background: #f57c00; color: white; border-color: #f57c00; }
        .p-btn.active { border: 2px solid #1a237e; }
        
        .legend { 
            padding: 8px; 
            font-size: 11px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 4px; 
            border-top: 1px solid #ddd;
            flex-shrink: 0;
        }
        
        .dot { 
            width: 8px; 
            height: 8px; 
            display: inline-block; 
            margin-right: 4px; 
            border-radius: 50%;
            vertical-align: middle;
        }
        
        /* Language Toggle */
        .lang-tog { 
            display: flex; 
            gap: 4px;
        }
        
        .t-btn { 
            padding: 5px 8px; 
            border: 1px solid #1a237e; 
            background: white; 
            cursor: pointer; 
            font-size: 11px;
            border-radius: 3px;
            transition: 0.2s;
        }
        
        .t-btn:hover { background: #f0f0f0; }
        .t-btn.active { background: #1a237e; color: white; }
        
        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .sidebar { width: 250px; }
            .palette-grid { grid-template-columns: repeat(4, 1fr); }
        }
        
        @media (max-width: 768px) {
            body { height: auto; min-height: 100vh; }
            
            .top-bar { 
                height: auto; 
                padding: 12px 15px;
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .top-bar h3 { font-size: 16px; }
            
            .wrapper { 
                flex-direction: column;
                gap: 0;
            }
            
            .q-area { 
                padding: 15px;
                min-height: 50vh;
            }
            
            .q-header { 
                flex-direction: column;
                align-items: flex-start;
            }
            
            .q-text { font-size: 15px; margin-bottom: 15px; }
            .q-hindi { font-size: 16px; }
            
            .opt-label { padding: 10px 12px; font-size: 13px; }
            
            .footer { 
                padding-top: 15px;
                gap: 6px;
            }
            
            .btn { 
                padding: 9px 12px;
                font-size: 12px;
                min-width: 80px;
                flex: 1;
            }
            
            .sidebar { 
                width: 100%;
                border-left: none;
                border-top: 1px solid #ddd;
                max-height: 40vh;
            }
            
            .palette-grid { 
                grid-template-columns: repeat(6, 1fr);
                gap: 5px;
                padding: 10px;
            }
            
            .candidate-info { 
                padding: 10px;
                font-size: 12px;
            }
            
            .legend { 
                padding: 6px;
                font-size: 10px;
                gap: 3px;
            }
            
            .dot { width: 7px; height: 7px; margin-right: 3px; }
        }
        
        @media (max-width: 480px) {
            .top-bar { padding: 10px 12px; }
            .top-bar h3 { font-size: 14px; }
            
            .timer { 
                font-size: 16px;
                padding: 4px 10px;
                min-width: 70px;
            }
            
            .q-area { 
                padding: 12px;
                min-height: 55vh;
            }
            
            .q-header { padding-bottom: 8px; margin-bottom: 15px; }
            .q-header h3 { font-size: 14px; }
            
            .lang-tog { gap: 3px; }
            .t-btn { padding: 4px 6px; font-size: 10px; }
            
            .q-text { font-size: 14px; margin-bottom: 12px; }
            .q-hindi { font-size: 15px; margin-bottom: 8px; }
            
            .options { gap: 8px; }
            .opt-label { 
                padding: 9px 10px; 
                font-size: 12px;
            }
            
            .opt-input { width: 14px; height: 14px; margin-right: 10px; }
            
            .footer { 
                padding-top: 12px;
                gap: 5px;
            }
            
            .btn { 
                padding: 8px 10px;
                font-size: 11px;
                min-width: 70px;
            }
            
            .sidebar { 
                max-height: 35vh;
            }
            
            .palette-grid { 
                grid-template-columns: repeat(5, 1fr);
                gap: 4px;
                padding: 8px;
            }
            
            .p-btn { font-size: 11px; }
            
            .candidate-info { padding: 8px; font-size: 11px; }
            
            .legend { 
                padding: 5px;
                font-size: 9px;
                grid-template-columns: 1fr;
                gap: 2px;
            }
            
            .dot { width: 6px; height: 6px; }
        }
        
        @media (max-width: 360px) {
            .top-bar h3 { 
                font-size: 12px;
                word-break: break-word;
            }
            
            .timer { 
                font-size: 14px;
                padding: 3px 8px;
                min-width: 60px;
            }
            
            .q-area { padding: 10px; }
            
            .btn { 
                padding: 7px 8px;
                font-size: 10px;
            }
            
            .sidebar { max-height: 30vh; }
            
            .palette-grid { 
                grid-template-columns: repeat(4, 1fr);
                gap: 3px;
                padding: 6px;
            }
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <div class="top-bar">
        <h3 id="examTitle">Bihar Police SI - Set 1</h3>
        <div class="timer" id="timer">60:00</div>
    </div>

    <div class="wrapper">
        <div class="q-area">
            <div class="q-header">
                <h3 style="margin:0" id="qNum">Q1</h3>
                <div class="lang-tog">
                    <button class="t-btn active" onclick="setLang('both')">Both</button>
                    <button class="t-btn" onclick="setLang('hi')">Hindi</button>
                    <button class="t-btn" onclick="setLang('en')">English</button>
                </div>
            </div>
            
            <div id="qContent"></div>
            <div class="options" id="optContainer"></div>

            <div class="footer">
                <button class="btn btn-save" onclick="saveNext()">Save & Next</button>
                <button class="btn btn-mark" onclick="markReview()">Mark for Review</button>
                <button class="btn btn-clear" onclick="clearResp()">Clear Response</button>
                <button class="btn btn-submit" onclick="submitExam()">Submit Test</button>
            </div>
        </div>

        <div class="sidebar">
            <div class="candidate-info">
                <strong>Candidate:</strong> <span id="cName">...</span><br>
                <small>Roll: <span id="cRoll">...</span></small>
            </div>
            <div class="palette-grid" id="palette"></div>
            <div class="legend">
                <div><span class="dot" style="background:#2e7d32"></span>Answered</div>
                <div><span class="dot" style="background:#c62828"></span>Not Ans</div>
                <div><span class="dot" style="background:#f57c00"></span>Review</div>
                <div><span class="dot" style="background:white;border:1px solid #000"></span>Not Visited</div>
            </div>
        </div>
    </div>

    <script>
        if(!sessionStorage.getItem('si_auth')) window.location.href = 'si_login.html';
        
        // Dynamic Script Loader
        const urlParams = new URLSearchParams(window.location.search);
        const set = urlParams.get('set') || '1';
        sessionStorage.setItem('current_set', set);
        document.getElementById('examTitle').textContent = `Bihar Police SI - Set ${set}`;

        let scriptFile = 'siset1.js';
        if(set === '2') scriptFile = 'siset2.js';
        if(set === '3') scriptFile = 'siset3.js';
        if(set === '4') scriptFile = 'siset4.js';
        if(set === '5') scriptFile = 'siset5.js';
        if(set === '6') scriptFile = 'siset6.js';
        if(set === '7') scriptFile = 'siset7.js';
        if(set === '8') scriptFile = 'siset8.js';
        if(set === '9') scriptFile = 'siset9.js';
        if(set === '10') scriptFile = 'siset10.js';
        if(set === '11') scriptFile = 'siset11.js';
        if(set === '12') scriptFile = 'siset12.js';

        const script = document.createElement('script');
        script.src = scriptFile;
        script.onload = () => {
            if(typeof siQuestions !== 'undefined') {
                initExam();
            }
        };
        document.body.appendChild(script);
        
        // Init
        const totalTime = 60 * 60;
        let timeLeft = totalTime;
        let currentQ = 0;
        let answers = {};
        let qStatus;
        let langMode = 'both';

        document.getElementById('cName').textContent = "Aspiring SI";
        document.getElementById('cRoll').textContent = sessionStorage.getItem('si_user');

        // Render Question
        function renderQ(idx) {
            currentQ = idx;
            const q = siQuestions[idx];
            document.getElementById('qNum').textContent = `Question ${idx+1} / ${siQuestions.length}`;
            
            // Language Display Logic
            let html = '';
            if(langMode === 'both') {
                html = `<div class="q-hindi">${q.questionHindi}</div><div class="q-text">${q.question}</div>`;
            } else if(langMode === 'hi') {
                html = `<div class="q-hindi" style="font-size:22px">${q.questionHindi}</div>`;
            } else {
                html = `<div class="q-text">${q.question}</div>`;
            }
            document.getElementById('qContent').innerHTML = html;

            // Options
            const cont = document.getElementById('optContainer');
            cont.innerHTML = '';
            q.options.forEach((optText, i) => {
                const div = document.createElement('label');
                const isSelected = answers[q.id] === i;
                div.className = `opt-label ${isSelected ? 'selected' : ''}`;
                div.innerHTML = `
                    <input type="radio" name="opt" class="opt-input" ${isSelected ? 'checked' : ''}>
                    <span>${optText}</span>
                `;
                div.onclick = (e) => {
                    // prevent double trigger on radio click
                    if(e.target.tagName !== 'INPUT') div.querySelector('input').checked = true;
                    answers[q.id] = i;
                    renderQ(currentQ); // Re-render for style update
                };
                cont.appendChild(div);
            });
            
            updatePalette();
        }

        function updatePalette() {
            const pal = document.getElementById('palette');
            pal.innerHTML = '';
            siQuestions.forEach((q, i) => {
                const btn = document.createElement('div');
                let cls = 'p-btn ';
                
                if(i === currentQ) cls += 'active ';
                
                if(qStatus[i] === 1) cls += 'ans';
                else if(qStatus[i] === 2) cls += 'not-ans';
                else if(qStatus[i] === 3) cls += 'marked';
                
                btn.className = cls;
                btn.textContent = i+1;
                btn.onclick = () => renderQ(i);
                pal.appendChild(btn);
            });
        }

        function saveNext() {
            if(answers[siQuestions[currentQ].id] !== undefined) qStatus[currentQ] = 1;
            else qStatus[currentQ] = 2;
            
            if(currentQ < siQuestions.length - 1) renderQ(currentQ + 1);
            else updatePalette();
        }

        function markReview() {
            qStatus[currentQ] = 3;
            if(currentQ < siQuestions.length - 1) renderQ(currentQ + 1);
            else updatePalette();
        }

        function clearResp() {
            delete answers[siQuestions[currentQ].id];
            qStatus[currentQ] = 2;
            renderQ(currentQ);
        }

        function setLang(mode) {
            langMode = mode;
            document.querySelectorAll('.t-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            renderQ(currentQ);
        }

        function submitExam() {
            if(confirm("Submit Exam? You cannot go back.")) {
                finish();
            }
        }

        function finish() {
            const result = {
                answers: answers,
                questions: siQuestions // Pass the specific shuffled order
            };
            sessionStorage.setItem('si_result_data', JSON.stringify(result));
            window.location.href = 'si_result.html';
        }

        // Timer
        setInterval(() => {
            timeLeft--;
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `${m}:${s}`;
            if(timeLeft <= 0) finish();
        }, 1000);

        // Start
        function initExam() {
            qStatus = new Array(siQuestions.length).fill(0);
            
            const shuffleKey = `si_shuffled_set${set}`;
            if(!sessionStorage.getItem(shuffleKey)) {
                for(let i = siQuestions.length - 1; i > 0; i--){
                    const j = Math.floor(Math.random() * (i + 1));
                    [siQuestions[i], siQuestions[j]] = [siQuestions[j], siQuestions[i]];
                }
                sessionStorage.setItem(shuffleKey, JSON.stringify(siQuestions));
            } else {
                const saved = JSON.parse(sessionStorage.getItem(shuffleKey));
                for(let i=0; i<saved.length; i++) siQuestions[i] = saved[i];
            }
            
            renderQ(0);
        }
    </script>
</body>
</html>